# 实盘交易模块项目结构

## 📁 文件结构

```
src/main/java/com/stocktrading/live/
├── Order.java                    // 订单实体类
├── Position.java                 // 持仓实体类
├── Account.java                  // 账户实体类
├── BrokerAPI.java               // 券商API接口
├── MockBrokerAPI.java           // 模拟券商API实现
├── RiskManager.java             // 风险管理器
├── OrderExecutor.java           // 订单执行器
├── LiveTradingEngine.java       // 实盘交易引擎
└── TradingConfig.java           // 交易配置类

src/main/java/com/stocktrading/examples/
└── LiveTradingExample.java      // 实盘交易使用示例

文档/
└── 实盘交易使用指南.md           // 完整使用文档
```

## 🎯 核心组件说明

### 1. 实体类（Entity Classes）

#### Order.java
- **功能**：表示交易订单
- **关键字段**：
  - `orderId`: 订单ID
  - `symbol`: 股票代码
  - `orderType`: BUY/SELL
  - `priceType`: MARKET/LIMIT
  - `status`: PENDING/SUBMITTED/FILLED/CANCELLED/REJECTED
  - `quantity`: 订单数量
  - `filledQuantity`: 已成交数量
  - `avgFillPrice`: 平均成交价
- **核心方法**：
  - `isFinished()`: 判断订单是否完成
  - `isCancellable()`: 判断订单是否可取消

#### Position.java
- **功能**：表示持仓信息
- **关键字段**：
  - `symbol`: 股票代码
  - `quantity`: 持仓数量
  - `avgCost`: 平均成本价
  - `currentPrice`: 当前价格
  - `unrealizedPnL`: 浮动盈亏
  - `unrealizedPnLPct`: 浮动盈亏百分比
- **核心方法**：
  - `updatePrice()`: 更新价格和盈亏
  - `addPosition()`: 增加持仓
  - `reducePosition()`: 减少持仓

#### Account.java
- **功能**：管理账户资金和持仓
- **关键字段**：
  - `cash`: 可用资金
  - `frozenCash`: 冻结资金
  - `totalAssets`: 总资产
  - `positions`: 持仓映射
- **核心方法**：
  - `freezeCash()`: 冻结资金
  - `unfreezeCash()`: 解冻资金
  - `onBuyFilled()`: 买入成交处理
  - `onSellFilled()`: 卖出成交处理
  - `updatePositionPrices()`: 批量更新持仓价格

### 2. 接口层（Interface Layer）

#### BrokerAPI.java
- **功能**：券商API统一接口
- **设计理念**：定义标准操作，支持多种券商实现
- **核心方法**：
  - 连接管理：`connect()`, `disconnect()`, `isConnected()`
  - 订单操作：`submitOrder()`, `cancelOrder()`, `getOrder()`
  - 查询功能：`getAccount()`, `getPositions()`, `getCurrentPrice()`
  - 事件订阅：`subscribeOrderUpdates()`, `subscribePositionUpdates()`

#### MockBrokerAPI.java
- **功能**：模拟券商实现，用于测试
- **模拟机制**：
  - 立即成交（简化版）
  - 考虑滑点和手续费
  - 资金冻结/解冻
  - 持仓更新
- **配置参数**：
  - `slippage`: 滑点（默认0.01%）
  - `commission`: 手续费率（默认0.03%）
  - `minCommission`: 最低手续费（默认5元）

### 3. 风险控制（Risk Management）

#### RiskManager.java
- **功能**：多维度风险控制
- **风控维度**：
  1. **仓位控制**
     - 单个持仓最大比例：30%
     - 总持仓最大比例：95%
     - 最小现金储备：5%
  2. **订单控制**
     - 单笔订单最大金额比例：20%
     - 订单数量验证（必须是100的整数倍）
  3. **止损止盈**
     - 止损比例：8%
     - 止盈比例：15%
  4. **每日限制**
     - 单日最大亏损：5%
     - 触发后自动停止交易
- **核心方法**：
  - `checkOrder()`: 订单风险检查
  - `shouldStopLoss()`: 判断是否需要止损
  - `shouldTakeProfit()`: 判断是否需要止盈
  - `calculateSuggestedQuantity()`: 计算建议买入量
  - `checkDailyLoss()`: 检查每日亏损

### 4. 执行层（Execution Layer）

#### OrderExecutor.java
- **功能**：异步订单执行和监控
- **特性**：
  - 异步执行（CompletableFuture）
  - 自动风险检查
  - 订单状态监控
  - 止损止盈监控
- **核心方法**：
  - `executeBuy()`: 执行买入（返回Future）
  - `executeSell()`: 执行卖出（返回Future）
  - `executeMarketBuy()`: 市价买入
  - `executeMarketSell()`: 市价卖出
  - `startOrderMonitoring()`: 启动订单监控
  - `startStopLossMonitoring()`: 启动止损止盈监控

### 5. 引擎层（Engine Layer）

#### LiveTradingEngine.java
- **功能**：实盘交易主引擎
- **职责**：
  - 整合所有组件
  - 管理交易生命周期
  - 执行定时任务
  - 监控股票列表
- **定时任务**：
  1. 开盘前准备（9:00）：重置风控、同步账户
  2. 交易时段扫描（9:30-15:00）：扫描信号、执行交易
  3. 收盘后统计（15:30）：输出报表、记录日志
- **核心方法**：
  - `start()`: 启动引擎
  - `stop()`: 停止引擎
  - `setWatchList()`: 设置监控股票
  - `manualBuy()`: 手动买入
  - `manualSell()`: 手动卖出

#### TradingConfig.java
- **功能**：交易配置管理
- **预设配置**：
  - `createConservative()`: 保守型（风险低）
  - `createDefault()`: 标准型（风险中等）
  - `createAggressive()`: 激进型（风险高）
- **可配置参数**：14个风险和交易参数

## 🔄 工作流程

### 完整交易流程

```
1. 启动准备
   ├─ 连接券商API
   ├─ 初始化风险管理器
   ├─ 启动订单执行器
   └─ 启动定时任务

2. 开盘前（9:00）
   ├─ 重置每日风控统计
   ├─ 同步账户信息
   └─ 输出账户状态

3. 交易时段（9:30-15:00，每分钟）
   ├─ 遍历监控股票列表
   ├─ 获取历史数据
   ├─ 计算特征（简化版）
   ├─ 生成交易信号
   ├─ 检查信号置信度
   ├─ 执行风险检查
   ├─ 提交订单
   └─ 更新账户状态

4. 止损止盈监控（每10秒）
   ├─ 遍历所有持仓
   ├─ 检查止损条件
   ├─ 检查止盈条件
   ├─ 触发则市价卖出
   └─ 检查每日亏损限制

5. 收盘后（15:30）
   ├─ 同步账户信息
   ├─ 输出持仓明细
   ├─ 输出今日交易
   └─ 生成统计报表
```

### 订单执行流程

```
用户/引擎发起 → 创建订单对象 → 风险检查
                                ↓
                            检查通过？
                          ↙YES    NO↘
                    提交订单      拒绝订单
                        ↓
                    冻结资金（买入）
                        ↓
                  订单状态：SUBMITTED
                        ↓
                    模拟成交
                        ↓
              更新账户（买入/卖出）
                        ↓
              订单状态：FILLED
                        ↓
              通知监听器
```

## 🚀 快速使用

### 最简单的例子

```java
// 1. 加载模型
Classifier model = ModelPersistence.loadModel("model.model");
Instances header = ModelPersistence.loadTrainingHeader("header.arff");
SignalGenerator signalGen = new SignalGenerator(model, header, 0.6, 0.6);

// 2. 创建模拟券商
DataSource dataSource = new TushareDataSource("YOUR_TOKEN");
MockBrokerAPI broker = new MockBrokerAPI("ACCOUNT", 100000, dataSource);

// 3. 创建交易引擎
TradingConfig config = TradingConfig.createConservative();
LiveTradingEngine engine = new LiveTradingEngine(broker, signalGen, dataSource, config);

// 4. 设置监控股票
engine.setWatchList(Arrays.asList("600519.SH", "000858.SZ"));

// 5. 启动
engine.start();

// 6. 优雅关闭
Runtime.getRuntime().addShutdownHook(new Thread(engine::stop));
```

## 📊 监控和日志

### 关键日志输出

1. **启动阶段**
   ```
   [INFO] 连接到模拟券商API...
   [INFO] 模拟券商API连接成功
   [INFO] 启动实盘交易引擎...
   [INFO] 交易引擎已启动，监控股票数：4
   ```

2. **交易信号**
   ```
   [INFO] 股票：600519.SH 价格：1850.0 信号：BUY 置信度：0.75 持仓：0
   [INFO] 执行买入：600519.SH x 500 @ 1850.0
   [INFO] 订单已提交：MOCK1001
   [INFO] 订单已成交：MOCK1001 @ 1850.18
   ```

3. **风险控制**
   ```
   [WARN] 风险检查失败：单个持仓比例超限
   [WARN] 触发止损：600519.SH 亏损 -8.5%
   [ERROR] 触发每日最大亏损限制：-5.2%，暂停交易
   ```

4. **每日报表**
   ```
   [INFO] ========== 收盘后统计 ==========
   [INFO] 账户ID：TEST_ACCOUNT
   [INFO] 可用资金：45230.50
   [INFO] 持仓市值：52800.00
   [INFO] 总资产：98030.50
   [INFO] 持仓数量：3
   ```

## ⚠️ 重要提醒

### 在实盘使用前必须：

1. ✅ **充分回测**：使用BacktestEngine进行至少1年的历史数据回测
2. ✅ **模拟交易**：使用MockBrokerAPI模拟交易至少1-3个月
3. ✅ **小额测试**：实盘初期使用小额资金（如1万元）
4. ✅ **逐步放大**：确认策略稳定后再逐步增加资金
5. ✅ **持续监控**：实盘运行时必须持续监控，及时处理异常
6. ✅ **风险隔离**：不要使用全部资金，保持足够的安全边际

### 风险警告：

- 📉 模拟交易不等于实盘交易
- 📉 历史收益不代表未来表现
- 📉 市场存在不可预测的黑天鹅事件
- 📉 系统可能出现技术故障
- 📉 网络延迟可能导致滑点扩大
- 📉 作者不对任何投资损失负责

## 🔧 扩展点

### 1. 实现真实券商API

```java
public class MyBrokerAPI implements BrokerAPI {
    private MyBrokerClient client;
    
    @Override
    public boolean connect() {
        // 连接真实券商系统
        client = new MyBrokerClient(apiKey, secret);
        return client.connect();
    }
    
    @Override
    public String submitOrder(Order order) {
        // 调用券商API提交真实订单
        return client.placeOrder(order);
    }
    
    // ... 实现其他方法
}
```

### 2. 增强特征工程

当前实现使用简化的特征提取，建议：
- 集成完整的FeatureEngineer类
- 计算所有24个技术指标特征
- 保持与训练模型一致的特征

### 3. 添加数据库持久化

```java
// 保存交易记录到数据库
public class TradeRecorder {
    public void recordOrder(Order order) {
        // INSERT INTO orders ...
    }
    
    public void recordPosition(Position position) {
        // INSERT INTO positions ...
    }
}
```

### 4. 集成通知系统

```java
// 重要事件通知
public interface NotificationService {
    void sendAlert(String message);
    void sendEmail(String subject, String body);
    void sendWeChat(String message);
}
```

## 📝 总结

实盘交易模块提供了一个完整、可扩展的自动化交易框架。关键特性包括：

- ✅ 清晰的架构设计（实体-接口-执行-引擎）
- ✅ 完善的风险控制（多维度、多层次）
- ✅ 异步订单执行（高性能、可靠）
- ✅ 灵活的配置管理（三种预设+自定义）
- ✅ 模拟交易支持（充分测试）
- ✅ 易于扩展（接口化设计）

**记住：安全第一，谨慎操作！**
