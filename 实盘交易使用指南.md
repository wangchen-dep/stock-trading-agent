# 实盘交易模块使用指南

## 📋 目录
1. [模块概述](#模块概述)
2. [核心组件](#核心组件)
3. [快速开始](#快速开始)
4. [配置说明](#配置说明)
5. [风险控制](#风险控制)
6. [安全警告](#安全警告)

---

## 模块概述

实盘交易模块提供了完整的自动化交易解决方案，支持模拟交易和实盘交易。主要特性包括：

- ✅ **券商API抽象层**：统一的接口支持多种券商
- ✅ **模拟交易支持**：完整的模拟交易环境用于测试
- ✅ **风险管理系统**：多层次风险控制和仓位管理
- ✅ **订单执行引擎**：异步订单执行和监控
- ✅ **止损止盈**：自动化的止损止盈机制
- ✅ **实时监控**：账户、持仓、订单的实时监控

---

## 核心组件

### 1. BrokerAPI接口
券商API的统一抽象接口，定义了交易系统的标准操作。

```java
public interface BrokerAPI {
    boolean connect();                          // 连接券商
    String submitOrder(Order order);            // 提交订单
    boolean cancelOrder(String orderId);        // 取消订单
    Account getAccount();                       // 获取账户信息
    Map<String, Position> getPositions();       // 获取持仓
    double getCurrentPrice(String symbol);      // 获取实时价格
}
```

**实现类**：
- `MockBrokerAPI`：模拟券商，用于测试（已实现）
- `RealBrokerAPI`：真实券商接口（需根据实际券商API实现）

### 2. Order（订单类）
表示一个交易订单的完整信息。

```java
Order order = new Order(
    "600519.SH",              // 股票代码
    Order.OrderType.BUY,      // 买入/卖出
    Order.PriceType.LIMIT,    // 限价/市价
    1850.0,                   // 价格
    100                       // 数量
);
```

**订单状态流转**：
```
PENDING → SUBMITTED → PARTIAL → FILLED
                   ↘ CANCELLED
                   ↘ REJECTED
```

### 3. Account（账户类）
管理资金和持仓信息。

```java
Account account = brokerAPI.getAccount();
double cash = account.getCash();              // 可用资金
double totalAssets = account.getTotalAssets(); // 总资产
Map<String, Position> positions = account.getPositions(); // 持仓
```

### 4. RiskManager（风险管理器）
多维度风险控制系统。

**风险控制指标**：
| 参数 | 默认值 | 说明 |
|------|--------|------|
| maxPositionSize | 30% | 单个持仓最大比例 |
| maxTotalPosition | 95% | 总持仓最大比例 |
| minCashReserve | 5% | 最小现金储备 |
| stopLossPercent | 8% | 止损比例 |
| takeProfitPercent | 15% | 止盈比例 |
| maxDailyLoss | 5% | 单日最大亏损 |

```java
RiskManager riskManager = new RiskManager(initialAssets);
riskManager.setStopLossPercent(0.08);        // 设置8%止损
riskManager.setTakeProfitPercent(0.15);      // 设置15%止盈
```

### 5. OrderExecutor（订单执行器）
负责订单的异步执行和监控。

```java
OrderExecutor executor = new OrderExecutor(brokerAPI, riskManager);

// 异步执行买入
executor.executeBuy("600519.SH", 1850.0, 100)
    .thenAccept(result -> {
        if (result.isSuccess()) {
            logger.info("订单成功：{}", result.getOrderId());
        }
    });

// 启动监控
executor.startOrderMonitoring();        // 订单状态监控
executor.startStopLossMonitoring();     // 止损止盈监控
```

### 6. LiveTradingEngine（实盘交易引擎）
整合所有组件的核心交易引擎。

```java
LiveTradingEngine engine = new LiveTradingEngine(
    brokerAPI,
    signalGenerator,
    dataSource,
    featureEngineer,
    config
);

// 设置监控股票
engine.setWatchList(Arrays.asList("600519.SH", "000858.SZ"));

// 启动引擎
engine.start();
```

---

## 快速开始

### 步骤1：准备模型和数据源

```java
// 加载训练好的模型
Classifier classifier = ModelPersistence.loadModel("models/model.model");
Instances header = ModelPersistence.loadTrainingHeader("models/header.arff");

// 初始化数据源
DataSource dataSource = new TushareDataSource("your_token");
FeatureEngineer featureEngineer = new FeatureEngineer();
SignalGenerator signalGenerator = new SignalGenerator(classifier, header);
```

### 步骤2：创建模拟券商API

```java
// 创建模拟券商（初始资金10万）
MockBrokerAPI brokerAPI = new MockBrokerAPI("ACCOUNT_001", 100000.0, dataSource);

// 配置交易成本
brokerAPI.setSlippage(0.0001);       // 滑点0.01%
brokerAPI.setCommission(0.0003);     // 手续费0.03%
brokerAPI.setMinCommission(5.0);     // 最低5元
```

### 步骤3：创建交易配置

```java
// 使用预设配置
TradingConfig config = TradingConfig.createConservative(); // 保守型
// TradingConfig config = TradingConfig.createDefault();      // 标准型
// TradingConfig config = TradingConfig.createAggressive();   // 激进型

// 或自定义配置
TradingConfig config = new TradingConfig();
config.setMaxPositionSize(0.2);      // 单个持仓20%
config.setStopLossPercent(0.05);     // 5%止损
config.setMinConfidence(0.7);        // 最小70%置信度
```

### 步骤4：启动交易引擎

```java
LiveTradingEngine engine = new LiveTradingEngine(
    brokerAPI, signalGenerator, dataSource, featureEngineer, config
);

// 设置监控股票列表
engine.setWatchList(Arrays.asList(
    "600519.SH",  // 贵州茅台
    "000858.SZ",  // 五粮液
    "601318.SH"   // 中国平安
));

// 启动引擎
engine.start();

// 添加关闭钩子
Runtime.getRuntime().addShutdownHook(new Thread(() -> {
    engine.stop();
}));
```

### 步骤5：手动交易（可选）

```java
// 手动买入
engine.manualBuy("600519.SH", 1850.0, 100)
    .thenAccept(result -> {
        System.out.println("买入结果：" + result);
    });

// 手动卖出
engine.manualSell("600519.SH", 1850.0, 100)
    .thenAccept(result -> {
        System.out.println("卖出结果：" + result);
    });

// 取消订单
engine.cancelOrder("ORDER_ID");
```

---

## 配置说明

### 三种预设配置

#### 1. 保守型（Conservative）
```java
TradingConfig config = TradingConfig.createConservative();
```
- 单个持仓：20%
- 总持仓：80%
- 现金储备：20%
- 止损：5%
- 止盈：10%
- 最小置信度：70%
- 最大持股数：5只

**适用场景**：风险厌恶型、初学者、小资金账户

#### 2. 标准型（Default）
```java
TradingConfig config = TradingConfig.createDefault();
```
- 单个持仓：30%
- 总持仓：95%
- 现金储备：5%
- 止损：8%
- 止盈：15%
- 最小置信度：60%
- 最大持股数：10只

**适用场景**：一般投资者、中等风险承受能力

#### 3. 激进型（Aggressive）
```java
TradingConfig config = TradingConfig.createAggressive();
```
- 单个持仓：40%
- 总持仓：100%
- 现金储备：0%
- 止损：10%
- 止盈：20%
- 最小置信度：50%
- 最大持股数：15只

**适用场景**：高风险承受能力、经验丰富的交易者

### 自定义配置

```java
TradingConfig config = new TradingConfig();

// 仓位控制
config.setMaxPositionSize(0.25);        // 单仓25%
config.setMaxTotalPosition(0.9);        // 总仓90%
config.setMinCashReserve(0.1);          // 保留10%现金

// 止损止盈
config.setStopLossPercent(0.06);        // 6%止损
config.setTakeProfitPercent(0.12);      // 12%止盈

// 风险控制
config.setMaxDailyLoss(0.03);           // 单日最大3%亏损
config.setMinConfidence(0.65);          // 最小65%信号置信度

// 交易参数
config.setMaxHoldings(8);               // 最多持有8只股票
config.setScanInterval(60);             // 每60秒扫描一次
```

---

## 风险控制

### 1. 仓位控制
```java
// 风险检查
RiskManager.RiskCheckResult result = riskManager.checkOrder(order, account);
if (!result.isPass()) {
    System.out.println("风险检查未通过：" + result.getReason());
}

// 计算建议买入量
int quantity = riskManager.calculateSuggestedQuantity(symbol, price, account);
```

**控制维度**：
- ✓ 单个持仓比例限制
- ✓ 总持仓比例限制
- ✓ 单笔订单金额限制
- ✓ 最小现金储备要求
- ✓ 持仓数量限制

### 2. 止损止盈

**自动触发**：
```java
// 引擎会自动监控并执行
executor.startStopLossMonitoring();
```

**手动检查**：
```java
Position position = brokerAPI.getPosition("600519.SH");

if (riskManager.shouldStopLoss(position)) {
    // 触发止损
    engine.manualSell(symbol, currentPrice, position.getQuantity());
}

if (riskManager.shouldTakeProfit(position)) {
    // 触发止盈
    engine.manualSell(symbol, currentPrice, position.getQuantity());
}
```

### 3. 每日亏损限制

当账户触发单日最大亏损时，系统会自动停止交易：

```java
riskManager.checkDailyLoss(account);

if (!riskManager.isTradingEnabled()) {
    System.out.println("今日已触发最大亏损限制，交易已停止");
}

// 次日自动重置
riskManager.resetDailyStats(account);
```

### 4. 订单验证

所有订单在提交前都会经过验证：

```java
// 自动验证规则：
// ✓ 股票代码非空
// ✓ 数量大于0且为100的整数倍
// ✓ 限价单价格有效
// ✓ 买入时资金充足
// ✓ 卖出时持仓充足
```

---

## 安全警告

### ⚠️ 重要提示

1. **模拟先行**
   ```java
   // 先使用MockBrokerAPI进行充分测试
   MockBrokerAPI mockAPI = new MockBrokerAPI(...);
   // 测试至少1-3个月，确认策略稳定后再考虑实盘
   ```

2. **小额起步**
   ```java
   // 实盘初期使用小额资金
   double initialCash = 10000.0;  // 从1万开始
   // 逐步增加，观察策略表现
   ```

3. **持续监控**
   ```java
   // 定期检查账户状态
   scheduler.scheduleAtFixedRate(() -> {
       Account account = engine.getAccount();
       logger.info("账户状态：{}", account);
   }, 0, 5, TimeUnit.MINUTES);
   ```

4. **风险隔离**
   - 不要使用全部资金
   - 设置合理的止损
   - 分散投资，不要重仓单只股票
   - 保持足够的现金储备

5. **合规要求**
   - 确保拥有合法的交易账户
   - 遵守券商的API使用规定
   - 了解并遵守相关法律法规
   - 注意交易频率限制

### 🚨 免责声明

- 本模块仅供学习和研究使用
- 模拟交易不等于实盘交易
- 历史收益不代表未来表现
- 投资有风险，使用需谨慎
- 作者不对任何投资损失负责

---

## 常见问题

### Q1: 如何切换到真实券商API？

实现`BrokerAPI`接口并替换`MockBrokerAPI`：

```java
public class MyBrokerAPI implements BrokerAPI {
    @Override
    public boolean connect() {
        // 连接到真实券商系统
    }
    
    @Override
    public String submitOrder(Order order) {
        // 调用券商API提交订单
    }
    
    // ... 实现其他方法
}

// 使用真实API
BrokerAPI realAPI = new MyBrokerAPI(apiKey, secret);
LiveTradingEngine engine = new LiveTradingEngine(realAPI, ...);
```

### Q2: 如何监控运行状态？

```java
// 1. 订阅订单更新
brokerAPI.subscribeOrderUpdates(order -> {
    logger.info("订单更新：{}", order);
});

// 2. 订阅持仓更新
brokerAPI.subscribePositionUpdates(position -> {
    logger.info("持仓更新：{}", position);
});

// 3. 定期输出账户状态
Account account = engine.getAccount();
logger.info("总资产：{:.2f}", account.getTotalAssets());
```

### Q3: 如何优化交易策略？

1. **回测验证**：在BacktestEngine中充分测试
2. **参数优化**：调整TradingConfig参数
3. **模型迭代**：使用更多数据训练更好的模型
4. **风险调整**：根据实际表现调整风险参数
5. **持续监控**：记录交易日志，分析交易表现

### Q4: 如何处理异常情况？

```java
// 引擎内置异常处理
try {
    engine.start();
} catch (Exception e) {
    logger.error("启动失败", e);
    engine.stop();
}

// 关闭钩子确保优雅关闭
Runtime.getRuntime().addShutdownHook(new Thread(() -> {
    logger.info("正在关闭...");
    engine.stop();
    brokerAPI.disconnect();
}));
```

---

## 总结

实盘交易模块提供了完整的自动化交易解决方案，但请记住：

1. **充分测试**：模拟交易 → 小额实盘 → 逐步放大
2. **风险控制**：严格遵守风险管理规则
3. **持续优化**：根据实际表现不断改进策略
4. **理性决策**：不要被短期波动影响判断
5. **谨慎操作**：投资有风险，入市需谨慎

祝交易顺利！📈
